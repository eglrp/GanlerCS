# 信息安全复习

[TOC]

![](https://i.loli.net/2019/10/25/ByfnEiIGRWpwxXq.png)

## 密码学基础

### 常见算法

- **对称加密：**加密和解密用同一个密钥（对称密码也叫私钥密码）
  - AES, DES, RC2/4, IDEA
- **非对称加密**：公钥加密，私钥解密（解决了密钥传递问题，公钥密码）；
  - RSA, DSA, EIGamal, ECC
- **单向散列函数**
  - MD5, DMDC, SHA, HMAC

### 安全需求

- **机密性**：嗅探攻击；
- **完整性**：恶意代码注入；
- **可控性**：ARP,IP,DNS欺骗；
- **不可否认性**：IP欺骗；
- **可用性**：DoS攻击；

### 常见攻击

- **中间人攻击**：通过一个中间人与两方交换信息（通讯的内容完全由中间人控制）；
  - **ARP欺骗**：被动攻击（出于协议涉及缺陷，属于身份伪装）；
    - ARP用于在数据链路层IP转MAC地址；
    - 在ARP缓存表机制存在一个缺陷，就是当请求主机收到ARP应答包后，不会去验证自己是否向对方主机发送过ARP请求包，就直接把这个返回包中的IP地址与MAC地址的对应关系保存进ARP缓存表中，如果原有相同IP对应关系，则原有的会被替换。
- **嗅探**：全广播情况下的缺点，可以通过交换网络解决；
- **DNS攻击**：身份伪装；

### 数字签名

非对称加密；

一般的步骤：

- 待验证方对消息的**摘要值**私钥加密；
- 验证方对密文进行公钥解密看是否是摘要值；

PKI的证书 = 公钥 + 让自己够的签名；

## L2TP

### PPP

- 网络接口层（数据链路层）
- 两个对等端的直接连接
- **LCP**协议：建立、配置和测试PPP
- **IPCP**协议：传输IP数据
  - 协商网络层参数
- **认证协议**：CHAP, PAP
- PPP协议流程：
  - LCP建立PPP链路
  - PAP/CHAP验证身份
  - 配置IP参数（IPCP）
  - LCP断开PPP链路

#### 认证协议PAP

基于口令，口令和账号直接明文传输；

无法防 **窃听、重放、穷举攻击**；

> 因为明文，所以可以窃听；
>
> 因为可以窃听，所以我们可以原封不动的发回去，进行重放攻击（加上他也没有计数器）；
>
> 因为没有加密，所以知道格式后可以直接穷举密码；

#### 认证协议CHAP

基于挑战式；

即认证方给被认证方一个随机数，其返回一个`HASH(ID, RANDOM, SECRET)`，来看对方算出的结果是否和我这边的结果一致；（没有明文，但能验证密码）

> 具有认证功能，但不具有数据机密性（只能验证人家密码对不对）；

#### CHAP可能面临的风险

建立连接时（LCP），中间人攻击，当中间人把chap降级为pap；

- 服务器要求要用CHAP，中间人截获，把CHAP字段改成不能识别的；
- 客户端就发拒绝认证（nak），中间人截获，将其降级为PAP转发；

### L2TP

- 作用于数据链路层；
- 工作于应用层（基于UDP，端口号1701），实现的是数据链路层的功能；
- 组成
  - LAC（L2TP接入集中器）
  - LNS（L2TP网络服务商）
  - （外网）远程主机
  - （内网）局域网

#### L2TP之于PPP的优点

1. PPP不适用于移动场合；
2. L2TP允许客户跨越多个IP网络建立的虚拟点到点链路；

#### L2TP以搭建虚拟的PPP链路

<img src="https://i.loli.net/2019/12/19/jW94AKOi8xvIUqd.png" style="zoom: 50%;" />

#### L2TP的安全功能

- **不提供数据机密性**（因为CHAP和PAP都是和口令相关的）；
- 只对口令等敏感信息进行加密；
- 基于共享密钥的身份认证方法；

### L2TP传输模式

- **强制模式**：主机发PPP帧（`[PPP, IP, message]`）给LAC，LAC对PPP进行L2TP封装（`[IP, UDP, L2TP, PPP, IP, message]`）后给LNS，LNS解析后把PPP给内网；（上图）
- **自发模式**：主机直接输出L2TP报文（`[IP, UDP, L2TP, IP, ...]`），然后和LNS连接；（少去了LAC加工的一步）（下图）

<img src="https://i.loli.net/2019/12/19/FR3V28B9STXhKsk.png" style="zoom: 50%;" />

> 注意，在L2TP Tunnel传输的时候，只用UDP。而在内网里的话，传输层协议想用啥用啥；

### L2TP架构

- **数据消息**：直接承载PPP，不加密也不可靠；`[L2TP首部, PPP帧]`
- **控制消息**：保证可靠性，用于会话的建立、维护与清除；`[L2TP首部, AVP * N]`

### L2TP流程

1. 通过L2TP的控制消息来建立隧道；
2. 建立会话（一个隧道可有多个会话）
   1. 呼入会话：来自远程主机的呼叫；
   2. 呼出会话：LNS的呼叫；
3. 通过虚拟PPP链路进行数据通讯；
4. 终止会话；
5. 通过L2TP的控制消息来销毁隧道；（回应方返回确认信息后，<u>为防止确认丢失，首先等待一段时间</u>，之后才在本地清除该控制连接。）

### L2TP的可靠性机制

L2TP基于不可靠的UDP，所以它增加了以下要求来确保控制消息的可靠投递机制；

1. 每个L2TP报文包含一个 **序号**，防止乱序和丢失；
2. L2TP使用**肯定确认**防止报文丢失；
3. <u>滑动窗口控制流量</u>；
4. 慢启动防拥塞；

### L2TP的安全性分析

- 不对PPP数据提供**机密性**和**完整性**保护；
- 基于共享秘密，可对控制消息的属性值进行加密；
- 基于共享秘密，**CHAP提供了身份认证功能**；
- <u>未提供共享秘密的生成方法</u>；
- L2TP与IPsec的结合；

---

## IPsec

### IPv4

![](https://i.loli.net/2019/12/19/5HIQdEajuDTsqkW.png)

> 子网掩码嘛，就是告诉你子网的位数；

### IPv6

- IP设计时未考虑任何安全机制问题
  - ARP攻击；
  - IP数据是明文传输；
- 内置IPsec
- 对于IPv4，IPsec只能算是其补充功能

### NAT

> 连接时，整个局域网用一个IP地址；

- 节省IP地址数；
- 局域网设备可随时更改地址，无需通知外部网络；
- 更换ISP时，无需变更局域网内部设备的地址；
- 更加安全，外界不知道内网设备的具体地址；

#### 实现

- 外出数据报；
- NAT转换表；
- 进来数据报；

#### 缺点

- 网桥（路由器）必须处理到网络层；
- 不能处理嵌入的IP地址或端口（嵌入数据已经被加密，位置未知）
- P2P应用无法使用
- 地址短缺应该上IPv6

### IPsec

#### 概述

- 对IP的保护
  - 提供身份认证、机密性和完整性；
  - **防止重放攻击**：
    - AH/ESP：序列号
    - IKE：Nonce
  - 对通信流提供有限机密性保护
    - ESP+隧道模式下，IP地址和端口号可能被加密；

- 在IP实现的**优势**：
  - **通用性**：IP是被所有高层共享的协议；
  - **灵活性**：点到点；
  - **安全策略统一性**：部署于网关可保护俩网络的进出安全；
- **劣势**：
  - 不便于开发：IP一般由内核实现；
  - 使用不方便：部署难；
  - 效率；

#### 组成

<img src="https://i.loli.net/2019/12/19/klDoa5g9hdLmwjN.png" style="zoom:33%;" />

- 在IP层的一整套协议体系结构；
  - **安全协议**：AH认证头/ESP封装安全载荷
  - **密钥管理**：IKE
  - 其他
- 组成
  - **<u>协商阶段</u>**：
    - 身份认证
    - 协商各种加密、认证策略
  - **<u>数据交互</u>**：
    - AH：只认证头部，不对报文做加密处理；
    - ESP：完整的认证；

#### 安全关联 SA

- 描述通讯数据的保护方法；
- <u>因为是双向通讯，所以双方都要有</u>；
- 和SA相关的；
  - SPD：安全策略库（一堆策略，即一套方案）
  - SAD：安全关联库（一堆SA，SA是一种保护方法）
  - SPD策略库中有很多策略，一个策略有很多参数，包括对SAD中一个或多个SA的选择；
- 可动态的删除与添加SA；

#### 具体

- 单向；
- `<SPI(安全索引), 目的IP, 安全协议(AH/ESP)>`；
- 决定SA服务的因素：
  - 安全协议（AH/ESP）
  - SA模式（**传输模式**/**隧道模式**）
  - SA作用的两端点

#### 安全协议

![](https://i.loli.net/2019/12/19/FmPDdjauR3SsHqr.png)

##### AH: 不加密只认证

- 传输模式：保护高层数据（数据+部分IP头）
- 隧道模式（就记住隧道模式要用新的IP头）：保护**整个IP数据报**和**部分新IP头**；

![](https://i.loli.net/2019/12/20/sygUvQfqB8c1CI9.png)

##### ESP: 认证又加密

![](https://i.loli.net/2019/12/20/gQXnsLU8CvH4ywx.png)

- 传输模式：
  - 不加密原IP头；
- 隧道模式：
  - 加密原IP头；

##### 联合AH & ESP

- 使用一束SAs（一个SA要么AH要么ESP）
- 先ESP再AH
  - 先加密再认证；
  - 好处是认证范围更大；
- 先AH再ESP
  - AH认证数据也被加密了；

#### 为什么IPsec要对进入和出去的两个SA进行单独控制

两个方向的安全需求一般不一样，比如进入的安全需求往往更高；

#### IPsec报文序号达到max时

达到$2^{32}-1$，重新协商SA；

### IKE的SA协商方法

> DH密钥交换；

- 基于数据签名的方法：挑战 + 被认证方的证书 + 签名
  - 认证方给被认证方一个随机数r（挑战）；
  - 被认证方私钥签名，把签名和证书发过去；
  - 认证方拿到证书，取出公钥，验证签名；
- 基于**公钥加密**（非对称加密）的方法：
- **改进的公钥加密**：
  - 部分信息公钥加密，部分信息对称加密以提升效率；

- IKE随机数nonce防重放攻击；
- cookies阻塞攻击
- 对D-H交换做认证来防止中间人攻击

#### L2TP+IPsec

- 首先在LAC和LNS建立L2TP通道；
- 然后在IP层建立IPsec；

![](https://i.loli.net/2019/12/25/kfsxUPN1DJvV5eW.png)

1. 远程客户的PPP帧到达LAC后，它首先将其组装为L2TP数据消息，之后沿着自己的协议栈向下递交给IP层，并用IPSec作安全处理后投递给LNS。
2. LNS收到报文后，首先用**IPSec 参数对其进行还原和验证**，之后沿着自己的协议栈逐层向上递交，交给L2TP。L2TP最后还原PPP帧后递交给目的端。

#### IPsec & NAT

> - NAT要改IP地址；
> - NAT要换端口号；

##### AH

- NAT与AH不兼容，AH头的ICV计算和目标IP地址有关，而NAT会修改IP地址，这就导致ICV验证无效；

##### ESP

- ESP认证和NAT不影响，因为ESP认证不认证IP头；
- ESP对TCP/UDP头加密后，在NAT转换无法看到端口号；

##### 解决方案：ESP前加个UDP头

![](https://i.loli.net/2019/12/25/39NCmtlPpYbvqEu.png)

- 看不到端口号就加个UDP层；

## SSL & TSL

> *<u>**传输层**协议</u>*；

**区别**：

IPsec是双向的，而SSL & TSL是「服务器认证必选」+「客户端认证可选」

### 架构

- **底层**：
  - 记录协议（数据传输）
    - 握手报文
    - 应用数据
- **上层**：
  - 握手协议
    - 「服务器认证必选」+「客户端认证可选」
    - 算法协商
    - 密钥生成
  - 更改密钥规范
    - 只包含一条消息
  - 警告协议；
    - 警告级
    - 致命级

### 重要概念

- **连接**：同TCP连接，即一次通讯过程；
- **会话**：握手协议获取的一系列参数；

> 一个会话可有多个连接。但每个会话有一个唯一**标识**；

### 基本流程

- 三次握手建立TCP连接
- SSL协议过程
  - 算法、密钥协商
  - 由「共享密钥」和「随机数」计算4个密钥
  - 数据交互
  - 用「可认证」的方式断开连接
- 断开TCP连接

> Finish信息（之前所有握手信息生成的MAC认证码）来**防止降级攻击**。

#### 客户端认证和服务端认证的不同

##### 服务器验证客户端

- 证书+签名
- 原理等同IKE数字签名认证

##### 客户端验证服务器

- 证书+公钥加密+消息认证码
  - 服务器要有正确的私钥才能解密
  - 才能生成正确的会话密钥
  - 才能用正确的会话密钥生成Finish消息
- 原理等同IKE数字签名认证

##### SSL「预主密」钥生成方式

- 密钥传输（RSA同时作为签名和加密算法）
  - 客户端选择预主密钥，使用服务器的公钥加密后发送给服务器。
- 密钥协商方式生成共享密钥
  - D-H交换

##### 密钥导出

「预主密钥」不直接用于保护数据，**而是生成4个用于数据保护的会话密钥**。

##### 记录协议

发送方：

1. 分片
2. 压缩
3. 计算MAC
4. 加密

接收方：

1. 解密
2. 验证MAC
3. 解压缩
4. 分片重组

### TSL vs SSL v3

- MAC计算方式不同
- 密钥导出方式不同
- 算法支持不同
  - SSL支持Fortezza，TSL not
  - SSLv3为临时D-H和Fortezza提供了附加的证书机制，但TLS not
  - TLS对于Kerbero、AES等协议定义了专门的加密套件，SSL v3 not
- TLS警告类型更多（12）
- 散列函数的输入不同
- 填充长度不同

### SSLv2 vs v3

- 版本值定义不同

- 组成不同

  - SSLv2仅包括握手和记录2个协议
  - SSLv2没有定义关闭连接的警告（无法防止截断攻击）
  - SSLv2错误以错误码形式给出

- 密码套件不同

- SSLv2只用2个密钥（v3有4个）

### SSL v2的安全问题

- 没有证书链，所以证书必须由CA颁发；
- 加密和计算MAC统一密钥
- 没有验证握手信息的措施
- 没有安全断联机制，无法防止截断攻击
- 「认证传输攻击」

### SSL应用

- 操作透明
- 用户可选
- 大量二次开发软件

#### 保护高层应用

> 分设端口不改变高层协议；

HTTP基于SSL访问的时候与433端口建立连接；

**向上协商**：需要改变应用层协议（SMTP(简单邮件传输协议)采用向上协商的策略使用SSL）

## SSH

> 应用层 TCP 22

- 机密性
- 完整性
- 身份认证

### 组成

- 传输层协议
- 用户认证协议（服务器认证客户端用户身份）
- 连接协议（方便多个高程应用共享SSH服务）

![](https://i.loli.net/2019/12/25/rmAiGhufaMSpH1J.png)

#### 密钥交换

- 数字签名认证（显示），客户端必须获得服务公钥：
  - 为每个服务器维护一个「名字/公钥」对；
  - 使用「CA」颁发的证书
- 预共享密钥：
  - 报文包含利用预共享密钥计算的MAC。

#### 4种认证方法

- 公钥认证（提供签名）
- 口令认证
- 基于主机认证
- none：不用认证

转发TCP/IP连接通道操作：

![](https://i.loli.net/2019/12/25/PoSKf41TBLbUksa.png)

#### 基于SSH的VPN

使用SSH的TCP/IP端口转发构架VPN。防火墙的访问控制列表ACL可仅配置为允许目前端口为22的通信量通过。

![](https://i.loli.net/2019/12/25/eIMnuUG4xQkDsLj.png)

## Socks

> 端口1080，可看做工作于应用层

在「传输层」和「应用层」之间垫了一层：

- Socks库
- Sockd守护进程

> 不支持ICMP转发

### Socks4的缺点 和 5的改进

#### Socks4

- 只能TCP不能UDP
- 不包含客户端身份认证
- 不支持加密

#### Socks5

- **增加对UDP的支持**
- **支持多种身份认证方案**
- **增加对IPv6的支持**
- 通过GSSAPI的认证，可支持公钥和私钥加密

### 优点

- 所有主机都可以作为代理服务器
- Socks5本身未定义「机密性和完整性保护」，所有通讯量都要经过代理服务器，为定义统一的安全则略提供了便利；
- Socks5支持多种客户认证方案；

### 框架

#### C/S模型

- Socks库：客户端、工作于传输层和应用层之间
- Sockd守护进程：安装于服务器、工作于应用层、端口1080

![](https://i.loli.net/2019/12/25/gDcE9QOX5ua36bv.png)

### 基于Socks的IPv4/6网关

可基于Socks5**域名寻址**方式来屏蔽两类地址的差异。

#### IPv4 -> 6

- 发起方使用IPv6报文格式，加个IPv4头，发给Socks网关；（这一步需要Socks库帮忙）
- Socks网关收到后剥去IPv4头，发IPv6报文。

#### IPv6 -> 4

> 楼上4/6置换；

## PGP

- 公钥环
- 私钥环
- 简单信任模型

### 功能

- 签名
- 完整性（认证）
- 加密
  - 对对称秘钥进行非对称加密，以节约时间
- 压缩
  - 签名后，加密前；
- 邮件兼容（Radix64）
- 数据分段

> **PGP**在每一个节点上提供一对数据结构：
>
> - 存储该节点拥有的公钥**/**私钥对； （私钥环）
>   - 时间
>   - KeyID
>   - 对应公钥
>   - 用户ID
>   - 加密后的私钥
> - 存储本节点知道的其他用户的公钥；（公钥环）
>   - 同上
>   - 包括用户信任，签名信任等一堆东西

### 信任模型

- 直接信任
- 分级信任
- 信任网

## 大杂烩

### 防重放

1. IPsec：IKE nonce  AH/ESP的序号
2. SSL：双方随机数
3. SSH：Cookies随机数

> SSLv3可以防截断、降级攻击；
>
> 防DoS攻击；
>
> 访问控制IPsec；

