# UNIX Network

## 一切皆文件

在UNIX上，对硬件的操作通过对文件的操作来完成。这里的文件都会被分配一个ID，即**File Descriptor**。

- 通常用 0 来表示标准输入文件（stdin），它对应的硬件设备就是键盘；
- 通常用 1 来表示标准输出文件（stdout），它对应的硬件设备就是显示器。

UNIX/Linux 程序在执行任何形式的 I/O 操作时，都是在读取或者写入一个文件描述符。一个文件描述符只是一个和打开的文件相关联的整数，它的背后可能是一个硬盘上的普通文件、FIFO、管道、终端、键盘、显示器，甚至是一个网络连接。

**网络连接也是一个文件，它也有文件描述符。**我们通过socket进行网络连接，所有的网络操作可以通过读写socket descriptor实现。（只要用 socket() 创建了连接，剩下的就是文件操作了）

## Socket类型

有很多种socket，一般我们用的是Internet Socket。Internet Socket也有很多分类。一般分2种：

#### 流格式套接字 SOCK_STREAM

> “面向连接的套接字”

<u>SOCK_STREAM 是一种可靠的、双向的通信数据流，数据可以准确无误地到达另一台计算机，如果损坏或丢失，可以重新发送。</u>

SOCK_STREAM 有以下几个特征：

- 数据在传输过程中不会消失；
- 数据是按照顺序传输的；
- 数据的发送和接收不是同步的（有的教程也称“不存在数据边界”）。

> 考虑传送带上的货物；接收者不需要和传送带保持同步，只要根据自己的节奏来装袋即可，不用管传送带传送了几批，也不用每到一批就装袋一次，可以等到凑够了 100 个水果再装袋。其实现是使用了**缓冲区**。

流格式套接字使用TCP协议，这也是为什么其可以达到如此高质量的数据传播。

> TCP/IP 前者保证正确性，后者控制如何从源头到目的地。
>
> 浏览器所使用的 http 协议就基于面向连接的套接字，因为必须要确保数据准确无误，否则加载的 HTML 将无法解析。

#### 数据报格式套接字 SOCK_DGRAM

> “无连接的套接字”

计算机只管传输数据，不作数据校验，如果数据在传输中损坏，或者没有到达另一台计算机，是没有办法补救的。也就是说，数据错了就错了，无法重传。

因为数据报套接字所做的校验工作少，所以在传输效率方面比流格式套接字要高。

可以将 SOCK_DGRAM 比喻成高速移动的摩托车快递，它有以下特征：

- **强调快速传输而非传输顺序；**
- 传输的数据可能丢失也可能损毁；
- <u>限制每次传输的数据大小</u>
- <u>数据的发送和接收是同步的</u>（有的教程也称“存在数据边界”，即每次发包都得接）。

> 使用的是UDP(User Datagram Protocol)
>
> QQ 视频聊天和语音聊天就使用 SOCK_DGRAM 来传输数据，因为首先要保证通信的效率，尽量减小延迟，而数据的正确性是次要的，即使丢失很小的一部分数据，视频和音频也可以正常解析，最多出现噪点或杂音，不会对通信质量有实质的影响。

## 面向连接与无连接的区别

面向连接好像有一条管道，它连接发送端和接收端，数据包都通过这条管道来传输。当然，两台计算机在通信之前必须先搭建好管道。

> 数据包的传输路径是路由器根据算法来计算出来的，算法会考虑很多因素，比如网络的拥堵状况、下一个路由器是否忙碌等。

无连接好像没头苍蝇乱撞，数据包没有固定路径，任意游走，只需要保证最终都到达接收端即可。

#### 对于无连接的套接字

每个包可以选择不同的路径，但这样到达的顺序不确定。而且如果没收到也不会重发。

#### 对于面向连接的套接字

必须首先确定路径。没有特殊情况的话，以后就固定地使用这条路径来传递数据包了。

这条路径是由路由器维护的，**路径上的所有路由器都要存储该路径的信息**（实际上只需要存储上游和下游的两个路由器的位置就行），所以路由器是有开销的。当通讯完毕的时候则断开连接并销毁路径。

> 发送端发送一个数据包，如何得到接收端的确认呢？很简单，为每一个数据包分配一个 ID，接收端接收到数据包以后，再给发送端返回一个数据包，告诉发送端我接收到了 ID 为 xxx 的数据包。

面向连接的套接字会比无连接的套接字多出很多数据包，因为发送端每发送一个数据包，接收端就会返回一个数据包。<u>此外，建立连接和断开连接的过程也会传递**很多数据包**。</u>

不但是数量多了，**每个数据包也变大了**：除了源端口和目的端口，面向连接的套接字还包括序号、确认信号、数据偏移、控制标志（通常说的 URG、ACK、PSH、RST、SYN、FIN）、窗口、校验和、紧急指针、选项等信息；而无连接的套接字则只包含长度和校验和信息。

> 总的来说，面向连接的套接字比无连接的套接字：
>
> - 数据包更多
> - 数据包更大

#### 总结

两种套接字各有优缺点：

- 无连接套接字传输效率高，但是不可靠，有丢失数据包、捣乱数据的风险；
- 有连接套接字非常可靠，万无一失，但是传输效率低，耗费资源多。

TCP:

- HTTP、FTP 
- DNS、视频和语音通话

## 网络模型

> 用来干嘛的，描述如何进行数据封装。
>
> 发消息从上到下，收消息从下到上。
>
> 如何封装以及如何拆包？给数据加包装的过程，实际上就是在数据的头部增加一个标志（一个数据块），表示数据经过了这一层，我已经处理过了。给数据拆包装的过程正好相反，就是去掉数据头部的标志，让它逐渐现出原形。

![OSI ä¸å±ç½ç»æ¨¡åå TCP/IP åå±ç½ç»æ¨¡åçå¯¹æ¯](http://c.biancheng.net/uploads/allimg/190124/1-1Z1241445324H.jpg)

> Socket编程是传输层的事情。

两台计算机进行通信时，必须遵守以下原则：

- 必须是同一层次进行通信，比如，A 计算机的应用层和 B 计算机的传输层就不能通信，因为它们不在一个层次，数据的拆包会遇到问题。
- 每一层的功能都必须相同，也就是拥有完全相同的网络模型。如果网络模型都不同，那不就乱套了，谁都不认识谁。
- 数据只能逐层传输，不能跃层。
- 每一层可以使用下层提供的服务，并向上层提供服务。
